name: Build and Deploy to Manitu

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: 'teclab'
        type: choice
        options:
          - teclab
  push:
    branches:
      - master 

jobs:
  build-and-deploy:
    name: Deploy to teclab
    runs-on: ubuntu-latest
    environment: teclab

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Node.js (or your runtime)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ðŸ“¦ Install dependencies
        run: yarn install

      - name: ðŸ—ï¸ Build the project
        run: yarn build

      # === Set up SSH ===
      - name: ðŸ” Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ§¹ Clear target directory on Manitu
        run: |
          echo "==> Cleaning $REMOTE_DIR..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "rm -rf ${{ vars.REMOTE_DIR }}*"

      - name: ðŸ“¤ Deploy to Manitu via SCP
        run: |
          echo "==> Copying files to $REMOTE_DIR..."
          rsync -avz --delete ./dist/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ vars.REMOTE_DIR }}


